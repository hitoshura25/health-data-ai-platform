# WebAuthn Server Complete Stack with Zero-Trust Architecture
# Auto-generated by @vmenon25/mcp-server-webauthn-client
#
# This docker-compose file provides a complete zero-trust WebAuthn stack:
# - Envoy Gateway (entry point with JWT verification)
# - WebAuthn Server (FIDO2/Passkey authentication + JWT issuer)
# - Example Service (Python FastAPI demonstrating JWT verification)
# - PostgreSQL 15 (with auto-schema initialization)
# - Redis 7 (session storage)
#
# Security: Passwords are stored as Docker secrets in ./secrets/
# Secrets are mounted as read-only files at /run/secrets/ in containers
#
# Architecture:
#   Client → Envoy Gateway (port 8000) → WebAuthn Server (JWT for /api/*)
#                                      → Example Service (protected endpoints)

services:
  # Envoy Gateway - Entry point for all traffic
  envoy-gateway:
    image: envoyproxy/envoy:v1.29-latest
    container_name: envoy-gateway
    environment:
      # JWKS cache duration (seconds) - configurable per environment
      # Default: 15s for fast rotation testing (CI uses 30s rotation cycles)
      # Production: override to 300s for 180-day rotation cycles
      - JWKS_CACHE_DURATION=${JWKS_CACHE_DURATION:-15}
    ports:
      - "8000:8000"  # Main gateway proxy
      - "9901:9901"  # Admin interface
    volumes:
      - ./envoy-gateway.yaml.template:/etc/envoy/envoy-gateway.yaml.template:ro
      - ./certs:/etc/envoy/certs:ro  # mTLS certificates
    entrypoint:
      - sh
      - -c
      - |
        # Set default value for JWKS_CACHE_DURATION if not provided
        CACHE_DURATION=$${JWKS_CACHE_DURATION:-15}
        # Process template with environment variable substitution using sed
        # Using | as delimiter and proper escaping for docker-compose
        sed "s|seconds: \$${JWKS_CACHE_DURATION:-15}|seconds: $$CACHE_DURATION|" \
          /etc/envoy/envoy-gateway.yaml.template > /tmp/envoy.yaml
        # Start Envoy with generated configuration
        exec envoy -c /tmp/envoy.yaml --service-cluster gateway
    depends_on:
      - webauthn-server
      - example-service-sidecar
    restart: unless-stopped
  postgres:
    image: postgres:15-alpine
    container_name: webauthn-postgres
    environment:
      POSTGRES_DB: webauthn
      POSTGRES_USER: webauthn_user
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
    secrets:
      - postgres_password
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # Auto-run schema initialization on first startup (PostgreSQL executes in alphabetical order)
      # Mount entire migrations directory for easier maintenance (add new migrations without updating docker-compose)
      - ./migrations:/docker-entrypoint-initdb.d:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U webauthn_user -d webauthn"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: webauthn-redis
    command: sh -c 'redis-server --requirepass "$$(cat /run/secrets/redis_password)"'
    secrets:
      - redis_password
    ports:
      - "6380:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # Jaeger - Distributed tracing (always included)
  jaeger:
    image: jaegertracing/all-in-one:1.53
    container_name: webauthn-jaeger
    ports:
      - "16687:16686"                      # Jaeger UI
      - "14268:14268"          # Collector HTTP
      - "14250:14250"          # Collector gRPC
      - "4319:4317"                # OTLP gRPC
      - "4320:4318"                # OTLP HTTP
      - "6831:6831/udp"        # Agent compact thrift
      - "6832:6832/udp"         # Agent binary thrift
      - "5778:5778"             # Agent config
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    restart: unless-stopped

  # WebAuthn Server - JWT issuer and FIDO2 authentication
  webauthn-server:
    image: hitoshura25/webauthn-server:latest
    container_name: webauthn-server
    # Note: No direct port exposure - access only through Envoy Gateway
    # Use entrypoint override to read secrets and set environment variables
    entrypoint:
      - sh
      - -c
      - |
        export MPO_AUTHN_DB_PASSWORD=$$(cat /run/secrets/postgres_password)
        export MPO_AUTHN_REDIS_PASSWORD=$$(cat /run/secrets/redis_password)
        export MPO_AUTHN_JWT_MASTER_ENCRYPTION_KEY=$$(cat /run/secrets/jwt_master_key)
        exec java $$JAVA_OPTS -jar /app/app.jar
    environment:
      # JVM optimization for containerized environments (from Dockerfile)
      JAVA_OPTS: "-XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0 -XX:+UseG1GC -XX:+UseStringDeduplication -XX:+OptimizeStringConcat -XX:+UnlockExperimentalVMOptions -XX:+EnableJVMCI -Djava.security.egd=file:/dev/./urandom"
      # Database configuration
      MPO_AUTHN_DB_HOST: postgres
      MPO_AUTHN_DB_PORT: 5432
      MPO_AUTHN_DB_NAME: webauthn
      MPO_AUTHN_DB_USERNAME: webauthn_user
      # Redis configuration
      MPO_AUTHN_REDIS_HOST: redis
      MPO_AUTHN_REDIS_PORT: 6379
      # WebAuthn configuration
      MPO_AUTHN_APP_RELYING_PARTY_ID: localhost
      MPO_AUTHN_APP_RELYING_PARTY_NAME: "Health Data AI Platform"
      # JWT Key Rotation Configuration (HOCON duration format)
      # Defaults: 180d rotation, 1h grace/retention (production values)
      # Override via .env file for testing (e.g., CI uses 30s rotation)
      MPO_AUTHN_JWT_KEY_ROTATION_ENABLED: "${MPO_AUTHN_JWT_KEY_ROTATION_ENABLED:-true}"
      MPO_AUTHN_JWT_KEY_ROTATION_INTERVAL: "${MPO_AUTHN_JWT_KEY_ROTATION_INTERVAL:-180d}"
      MPO_AUTHN_JWT_KEY_GRACE_PERIOD: "${MPO_AUTHN_JWT_KEY_GRACE_PERIOD:-1h}"
      MPO_AUTHN_JWT_KEY_RETENTION: "${MPO_AUTHN_JWT_KEY_RETENTION:-1h}"
      MPO_AUTHN_JWT_KEY_SIZE: "2048"
      MPO_AUTHN_JWT_KEY_ID_PREFIX: "webauthn"
    secrets:
      - postgres_password
      - redis_password
      - jwt_master_key
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  # Example Service Sidecar - Envoy proxy with mTLS termination
  example-service-sidecar:
    image: envoyproxy/envoy:v1.29-latest
    container_name: example-service-sidecar
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./istio/example-service-envoy.yaml:/etc/envoy/envoy.yaml:ro
      - ./certs:/etc/certs:ro  # mTLS certificates
    command: ["-c", "/etc/envoy/envoy.yaml", "--service-cluster", "example-service"]
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "bash -c '(echo > /dev/tcp/localhost/9902) >/dev/null 2>&1'"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 30s  # Increased for CI environment (was 10s)

  # Example Service - Demonstrates JWT verification (runs behind mTLS sidecar)
  example-service:
    build:
      context: ../example-service
      dockerfile: Dockerfile
    container_name: example-service
    network_mode: "service:example-service-sidecar"  # Share network with sidecar
    environment:
      APP_PORT: 9001  # App listens on 9001, Envoy sidecar exposes 9000
      # Fetch JWKS through gateway using host.docker.internal (works in both Docker Desktop and Engine)
      WEBAUTHN_JWKS_URL: "http://host.docker.internal:8000/.well-known/jwks.json"
      WEBAUTHN_JWKS_CACHE_LIFESPAN: "${WEBAUTHN_JWKS_CACHE_LIFESPAN:-300}"  # Default 5 min, override to 15s in CI
    depends_on:
      - webauthn-server
      - example-service-sidecar
    restart: unless-stopped

volumes:
  postgres_data:
    name: webauthn_postgres_data
  redis_data:
    name: webauthn_redis_data

# Docker secrets configuration
# Secrets are read from files in ./secrets/ directory
# These are auto-generated with secure random passwords by the MCP server
secrets:
  postgres_password:
    file: ./secrets/postgres_password
  redis_password:
    file: ./secrets/redis_password
  jwt_master_key:
    file: ./secrets/jwt_master_key
