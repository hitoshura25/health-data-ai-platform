{{- /*
Secrets Template for Infrastructure Layer
IMPORTANT: In production, replace these with Sealed Secrets
See: https://github.com/bitnami-labs/sealed-secrets
*/ -}}

---
# Namespace for infrastructure services
apiVersion: v1
kind: Namespace
metadata:
  name: {{ .Values.namespace }}
  labels:
    name: {{ .Values.namespace }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version }}

---
# ==============================================================================
# PostgreSQL Health Secret
# ==============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: postgresql-health-secret
  namespace: {{ .Values.namespace }}
  labels:
    app.kubernetes.io/name: postgresql-health
    app.kubernetes.io/component: database
    app.kubernetes.io/managed-by: {{ .Release.Service }}
type: Opaque
stringData:
  postgres-password: {{ .Values.secrets.postgresqlHealth.adminPassword | quote }}
  password: {{ .Values.secrets.postgresqlHealth.userPassword | quote }}
  username: {{ .Values.secrets.postgresqlHealth.username | quote }}
  database: {{ .Values.secrets.postgresqlHealth.database | quote }}

---
# ==============================================================================
# PostgreSQL Auth Secret
# ==============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: postgresql-auth-secret
  namespace: {{ .Values.namespace }}
  labels:
    app.kubernetes.io/name: postgresql-auth
    app.kubernetes.io/component: database
    app.kubernetes.io/managed-by: {{ .Release.Service }}
type: Opaque
stringData:
  postgres-password: {{ .Values.secrets.postgresqlAuth.adminPassword | quote }}
  password: {{ .Values.secrets.postgresqlAuth.userPassword | quote }}
  username: {{ .Values.secrets.postgresqlAuth.username | quote }}
  database: {{ .Values.secrets.postgresqlAuth.database | quote }}

---
# ==============================================================================
# Redis Health Secret
# ==============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: redis-health-secret
  namespace: {{ .Values.namespace }}
  labels:
    app.kubernetes.io/name: redis-health
    app.kubernetes.io/component: cache
    app.kubernetes.io/managed-by: {{ .Release.Service }}
type: Opaque
stringData:
  password: {{ .Values.secrets.redisHealth.password | quote }}

---
# ==============================================================================
# Redis Auth Secret
# ==============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: redis-auth-secret
  namespace: {{ .Values.namespace }}
  labels:
    app.kubernetes.io/name: redis-auth
    app.kubernetes.io/component: cache
    app.kubernetes.io/managed-by: {{ .Release.Service }}
type: Opaque
stringData:
  password: {{ .Values.secrets.redisAuth.password | quote }}

---
# ==============================================================================
# MinIO Secret
# ==============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: minio-secret
  namespace: {{ .Values.namespace }}
  labels:
    app.kubernetes.io/name: minio
    app.kubernetes.io/component: object-storage
    app.kubernetes.io/managed-by: {{ .Release.Service }}
type: Opaque
stringData:
  root-user: {{ .Values.secrets.minio.rootUser | quote }}
  root-password: {{ .Values.secrets.minio.rootPassword | quote }}

---
# ==============================================================================
# RabbitMQ Password Secret
# ==============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: rabbitmq-secret
  namespace: {{ .Values.namespace }}
  labels:
    app.kubernetes.io/name: rabbitmq
    app.kubernetes.io/component: message-queue
    app.kubernetes.io/managed-by: {{ .Release.Service }}
type: Opaque
stringData:
  rabbitmq-password: {{ .Values.secrets.rabbitmq.password | quote }}

---
# ==============================================================================
# RabbitMQ Erlang Cookie Secret
# ==============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: rabbitmq-erlang-secret
  namespace: {{ .Values.namespace }}
  labels:
    app.kubernetes.io/name: rabbitmq
    app.kubernetes.io/component: message-queue
    app.kubernetes.io/managed-by: {{ .Release.Service }}
type: Opaque
stringData:
  rabbitmq-erlang-cookie: {{ .Values.secrets.rabbitmq.erlangCookie | quote }}

---
# ==============================================================================
# ConfigMap for Service Connection Information
# ==============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: infrastructure-connection-info
  namespace: {{ .Values.namespace }}
  labels:
    app.kubernetes.io/name: infrastructure
    app.kubernetes.io/component: configuration
    app.kubernetes.io/managed-by: {{ .Release.Service }}
data:
  # PostgreSQL Health Connection
  POSTGRESQL_HEALTH_HOST: "{{ .Release.Name }}-postgresql-health.{{ .Values.namespace }}.svc.cluster.local"
  POSTGRESQL_HEALTH_PORT: "5432"
  POSTGRESQL_HEALTH_DATABASE: {{ .Values.secrets.postgresqlHealth.database | quote }}

  # PostgreSQL Auth Connection
  POSTGRESQL_AUTH_HOST: "{{ .Release.Name }}-postgresql-auth.{{ .Values.namespace }}.svc.cluster.local"
  POSTGRESQL_AUTH_PORT: "5432"
  POSTGRESQL_AUTH_DATABASE: {{ .Values.secrets.postgresqlAuth.database | quote }}

  # Redis Health Connection
  REDIS_HEALTH_HOST: "{{ .Release.Name }}-redis-health-master.{{ .Values.namespace }}.svc.cluster.local"
  REDIS_HEALTH_PORT: "6379"

  # Redis Auth Connection
  REDIS_AUTH_HOST: "{{ .Release.Name }}-redis-auth-master.{{ .Values.namespace }}.svc.cluster.local"
  REDIS_AUTH_PORT: "6379"

  # MinIO Connection
  MINIO_HOST: "{{ .Release.Name }}-minio.{{ .Values.namespace }}.svc.cluster.local"
  MINIO_API_PORT: "9000"
  MINIO_CONSOLE_PORT: "9001"
  MINIO_ENDPOINT: "http://{{ .Release.Name }}-minio.{{ .Values.namespace }}.svc.cluster.local:9000"

  # RabbitMQ Connection
  RABBITMQ_HOST: "{{ .Release.Name }}-rabbitmq.{{ .Values.namespace }}.svc.cluster.local"
  RABBITMQ_AMQP_PORT: "5672"
  RABBITMQ_MANAGEMENT_PORT: "15672"
  RABBITMQ_ENDPOINT: "amqp://{{ .Release.Name }}-rabbitmq.{{ .Values.namespace }}.svc.cluster.local:5672"

---
# ==============================================================================
# NOTES: Secrets Management Best Practices
# ==============================================================================
# For production deployments:
# 1. Use Sealed Secrets: https://github.com/bitnami-labs/sealed-secrets
# 2. Or use External Secrets Operator with OCI Vault
# 3. Never commit plaintext secrets to Git
# 4. Rotate secrets regularly (every 90 days minimum)
# 5. Use strong passwords (32+ characters, random)
#
# Example with Sealed Secrets:
#   kubectl create secret generic postgresql-health-secret \
#     --from-literal=postgres-password=$(openssl rand -base64 32) \
#     --from-literal=password=$(openssl rand -base64 32) \
#     --dry-run=client -o yaml | \
#     kubeseal -o yaml > postgresql-health-sealed.yaml
# ==============================================================================
