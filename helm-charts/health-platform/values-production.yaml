# Health Data AI Platform - Production Values
# Oracle Cloud Infrastructure - Always Free Tier
# Region: eu-amsterdam-1 (100% renewable energy)

# ==============================================================================
# Global Production Configuration
# ==============================================================================
global:
  # Image pull secrets (if using private registry)
  imagePullSecrets: []

  # Storage class for OCI Block Volumes
  storageClass: "oci-bv"

  # Monitoring configuration
  monitoring:
    namespace: health-observability
    enabled: true

  # Security settings
  podSecurityStandards:
    enforced: true
    profile: restricted

  # Domain configuration (CHANGE THIS to your domain)
  domain: "health-platform.example.com"

  # TLS/SSL configuration
  tls:
    enabled: true
    issuer: letsencrypt-prod

# ==============================================================================
# Infrastructure Layer - Production Configuration
# ==============================================================================
infrastructure:
  enabled: true

  # Namespace for infrastructure services
  namespace: health-data

  # Production secrets (IMPORTANT: Replace with Sealed Secrets or OCI Vault)
  secrets:
    postgresqlHealth:
      adminPassword: "CHANGE_ME_POSTGRESQL_HEALTH_ADMIN_PASSWORD_32_CHARS_MIN"
      userPassword: "CHANGE_ME_POSTGRESQL_HEALTH_USER_PASSWORD_32_CHARS_MIN"
      username: "healthapi"
      database: "healthdb"

    postgresqlAuth:
      adminPassword: "CHANGE_ME_POSTGRESQL_AUTH_ADMIN_PASSWORD_32_CHARS_MIN"
      userPassword: "CHANGE_ME_POSTGRESQL_AUTH_USER_PASSWORD_32_CHARS_MIN"
      username: "webauthn"
      database: "webauthn"

    redisHealth:
      password: "CHANGE_ME_REDIS_HEALTH_PASSWORD_32_CHARS_MIN"

    redisAuth:
      password: "CHANGE_ME_REDIS_AUTH_PASSWORD_32_CHARS_MIN"

    minio:
      rootUser: "admin"
      rootPassword: "CHANGE_ME_MINIO_PASSWORD_32_CHARS_MIN"

    rabbitmq:
      password: "CHANGE_ME_RABBITMQ_PASSWORD_32_CHARS_MIN"
      erlangCookie: "CHANGEME_REPLACE_WITH_32CHARS!!"

  # PostgreSQL Health - Production settings
  postgresql-health:
    enabled: true
    primary:
      persistence:
        size: 60Gi
      resources:
        requests:
          cpu: 300m
          memory: 1Gi
        limits:
          cpu: 500m
          memory: 2Gi

  # PostgreSQL Auth - Production settings
  postgresql-auth:
    enabled: true
    primary:
      persistence:
        size: 20Gi
      resources:
        requests:
          cpu: 150m
          memory: 512Mi
        limits:
          cpu: 300m
          memory: 1Gi

  # Redis Health - Production settings
  redis-health:
    enabled: true
    master:
      persistence:
        size: 5Gi
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 200m
          memory: 512Mi

  # Redis Auth - Production settings
  redis-auth:
    enabled: true
    master:
      persistence:
        size: 5Gi
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 200m
          memory: 512Mi

  # MinIO - Production settings
  minio:
    enabled: true
    persistence:
      size: 80Gi
    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        cpu: 400m
        memory: 1Gi
    ingress:
      enabled: true
      hostname: minio.health-platform.example.com  # CHANGE THIS

  # RabbitMQ - Production settings
  rabbitmq:
    enabled: true
    persistence:
      size: 15Gi
    resources:
      requests:
        cpu: 300m
        memory: 512Mi
      limits:
        cpu: 500m
        memory: 1Gi
    ingress:
      enabled: true
      hostname: rabbitmq.health-platform.example.com  # CHANGE THIS

# ==============================================================================
# WebAuthn Stack - Production Configuration (Module 3) ✅ IMPLEMENTED
# ==============================================================================
webauthn-stack:
  enabled: true

  namespace: health-auth

  # WebAuthn Server configuration
  webauthn:
    replicaCount: 2  # HA with 2 replicas
    resources:
      requests:
        cpu: 250m
        memory: 512Mi
      limits:
        cpu: 500m
        memory: 1Gi

    # WebAuthn configuration (CHANGE THESE VALUES!)
    config:
      relyingPartyId: "auth.health-platform.example.com"  # CHANGE THIS
      relyingPartyOrigin: "https://auth.health-platform.example.com"  # CHANGE THIS
      relyingPartyName: "Health Data AI Platform"

  # Envoy Gateway configuration
  envoy:
    replicaCount: 2
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 256Mi

  # Ingress configuration
  ingress:
    enabled: true
    host: "auth.health-platform.example.com"  # CHANGE THIS
    tls:
      enabled: true
      issuer: letsencrypt-prod

  # Secrets (IMPORTANT: Use Sealed Secrets or OCI Vault in production!)
  secrets:
    databasePassword: "CHANGE_ME_WEBAUTHN_DB_PASSWORD_32_CHARS_MIN"
    redisPassword: "CHANGE_ME_WEBAUTHN_REDIS_PASSWORD_32_CHARS_MIN"
    jwtMasterKey: "CHANGE_ME_BASE64_ENCODED_32_BYTE_KEY"  # openssl rand -base64 32

  # HorizontalPodAutoscaler
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilizationPercentage: 70

# ==============================================================================
# Health API - Production Configuration (Module 4) ✅ IMPLEMENTED
# ==============================================================================
health-api:
  enabled: true

  namespace: health-api

  # Deployment configuration
  replicaCount: 2
  resources:
    requests:
      cpu: 250m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # Docker image configuration
  image:
    repository: ghcr.io/hitoshura25/health-api  # CHANGE THIS to your registry
    tag: "latest"  # Use specific version tags in production
    pullPolicy: IfNotPresent

  # Service configuration
  service:
    type: ClusterIP
    port: 8001

  # Ingress configuration
  ingress:
    enabled: true
    host: "api.health-platform.example.com"  # CHANGE THIS
    tls:
      enabled: true
      issuer: letsencrypt-prod
    annotations:
      nginx.ingress.kubernetes.io/rate-limit: "100"
      nginx.ingress.kubernetes.io/proxy-body-size: "50m"

  # HorizontalPodAutoscaler
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80

  # Secrets (IMPORTANT: Use Sealed Secrets or OCI Vault!)
  secrets:
    secretKey: "CHANGE_ME_SECRET_KEY_MIN_32_CHARS_FOR_JWT_SIGNING"
    databasePassword: "CHANGE_ME_USE_SAME_AS_POSTGRESQL_HEALTH_PASSWORD"
    redisPassword: "CHANGE_ME_USE_SAME_AS_REDIS_HEALTH_PASSWORD"
    minioAccessKey: "CHANGE_ME_USE_SAME_AS_MINIO_ROOT_USER"
    minioSecretKey: "CHANGE_ME_USE_SAME_AS_MINIO_ROOT_PASSWORD"
    rabbitmqPassword: "CHANGE_ME_USE_SAME_AS_RABBITMQ_PASSWORD"

# ==============================================================================
# ETL Engine - Production Configuration (Module 4) ✅ IMPLEMENTED
# ==============================================================================
etl-engine:
  enabled: true

  namespace: health-etl

  # Deployment configuration
  replicaCount: 1  # Single replica for deduplication consistency
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 700m
      memory: 2Gi  # Higher limit for AI model loading

  # Docker image configuration
  image:
    repository: ghcr.io/hitoshura25/etl-narrative-engine  # CHANGE THIS
    tag: "latest"  # Use specific version tags in production
    pullPolicy: IfNotPresent

  # Service configuration
  service:
    type: ClusterIP
    port: 8002
    metricsPort: 8004

  # HorizontalPodAutoscaler (conservative for free tier)
  autoscaling:
    enabled: true
    minReplicas: 1
    maxReplicas: 3
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80

  # Persistent volume for deduplication database
  persistence:
    enabled: true
    storageClass: "oci-bv"
    size: 1Gi

  # AI Model configuration
  aiModel:
    modelCache: 5Gi  # EmptyDir volume for HuggingFace model cache
    maxTokens: 2048
    temperature: 0.7
    prefetchCount: 1  # Process one message at a time

  # Secrets (IMPORTANT: Use Sealed Secrets!)
  secrets:
    databasePassword: "CHANGE_ME_USE_SAME_AS_POSTGRESQL_HEALTH_PASSWORD"
    minioAccessKey: "CHANGE_ME_USE_SAME_AS_MINIO_ROOT_USER"
    minioSecretKey: "CHANGE_ME_USE_SAME_AS_MINIO_ROOT_PASSWORD"
    rabbitmqUser: "user"
    rabbitmqPassword: "CHANGE_ME_USE_SAME_AS_RABBITMQ_PASSWORD"

# ==============================================================================
# Observability Stack - Production Configuration (Module 5)
# ==============================================================================
observability:
  enabled: false  # Enable after Module 5 implementation

  # Future configuration
  # prometheus:
  #   retention: 30d
  #   storage: 20Gi
  # grafana:
  #   enabled: true
  # loki:
  #   retention: 7d
  #   storage: 5Gi

# ==============================================================================
# Production Deployment Checklist
# ==============================================================================
#
# Before deploying to production:
#
# [ ] 1. Secrets Management
#     - Replace all CHANGE_ME values with actual secrets
#     - Use Sealed Secrets or OCI Vault for production
#     - Generate strong passwords: openssl rand -base64 32
#     - Erlang cookie must be exactly 32 characters
#
# [ ] 2. Domain Configuration
#     - Update all *.health-platform.example.com to your domain
#     - Configure DNS records to point to OKE cluster
#     - Ensure cert-manager is installed for SSL certificates
#
# [ ] 3. Oracle Cloud Setup
#     - OKE cluster provisioned and configured
#     - StorageClass 'oci-bv' available
#     - Load balancer configured for ingress
#     - Network policies and security lists configured
#
# [ ] 4. Prerequisites
#     - NGINX Ingress Controller installed
#     - cert-manager installed with Let's Encrypt issuer
#     - Sealed Secrets controller installed (optional but recommended)
#     - Monitoring namespace created (health-observability)
#
# [ ] 5. Deployment Steps
#     a. Add Bitnami repository:
#        helm repo add bitnami https://charts.bitnami.com/bitnami
#        helm repo update
#
#     b. Update dependencies:
#        cd helm-charts/health-platform
#        helm dependency update
#
#     c. Test with dry-run:
#        helm install health-platform . \
#          -f values-production.yaml \
#          --namespace health-data \
#          --create-namespace \
#          --dry-run --debug
#
#     d. Deploy to production:
#        helm install health-platform . \
#          -f values-production.yaml \
#          --namespace health-data \
#          --create-namespace
#
# [ ] 6. Post-Deployment Verification
#     - kubectl get pods -n health-data
#     - kubectl get pvc -n health-data
#     - kubectl get svc -n health-data
#     - kubectl top nodes
#     - kubectl top pods -n health-data
#
# [ ] 7. Initialize Databases
#     - Create PostgreSQL databases and tables
#     - Create MinIO buckets
#     - Configure RabbitMQ queues and exchanges
#
# [ ] 8. Monitoring
#     - Verify ServiceMonitors are created
#     - Check Prometheus is scraping metrics
#     - Configure Grafana dashboards
#     - Set up alerting rules
#
# ==============================================================================
#
# Resource Summary (Oracle Always Free Tier) - Modules 1-4 Deployed:
#
# Infrastructure Layer (Module 2):
#   CPU Requests:  1150m (1.15 vCPU)
#   Memory Requests: ~3 Gi
#   Storage: 185 Gi
#
# WebAuthn Stack (Module 3):
#   CPU Requests:  ~700m (2x WebAuthn @ 250m, 2x Envoy @ 100m)
#   Memory Requests: ~1.3 Gi (2x WebAuthn @ 512Mi, 2x Envoy @ 128Mi)
#
# Health Services (Module 4):
#   CPU Requests:  ~700m (2x Health API @ 250m, 1x ETL @ 200m)
#   Memory Requests: ~1.3 Gi (2x Health API @ 256Mi, 1x ETL @ 512Mi)
#   Storage: 1 Gi (ETL deduplication DB)
#
# TOTAL PLATFORM USAGE:
#   CPU Requests:  ~2.55 vCPU out of 4 vCPU ✅ (63.75%)
#   CPU Limits:    ~6.2 vCPU (allows bursting)
#   Memory Requests: ~5.6 Gi out of 24 Gi ✅ (23.3%)
#   Memory Limits:   ~13.5 Gi (includes 5Gi model cache)
#   Storage:       186 Gi out of 200 Gi ✅ (93%)
#
# Remaining resources for Module 5 (Observability):
#   CPU:     ~1.45 vCPU
#   Memory:  ~18.4 Gi
#   Storage: ~14 Gi
#
# ==============================================================================
