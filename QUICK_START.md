# Quick Start - Health Data AI Platform

Get the entire platform running in under 2 minutes!

## Prerequisites

- Docker & Docker Compose v2.20+ (for `include` directive support)
- OpenSSL (for generating secure secrets)
- Bash shell

## Step 1: Generate Secure Configuration (30 seconds)

```bash
# Run the unified setup script
./setup-all-services.sh
```

This will:
- âœ… Generate secure random credentials for all services
- âœ… Create coordinated `.env` files across all services
- âœ… Configure PostgreSQL with multiple databases (healthapi, webauthn)
- âœ… Set up MinIO, RabbitMQ, Redis with matching credentials

**Output files created:**
```
infrastructure/.env           # Shared infrastructure config
services/data-lake/.env      # Data lake service config
services/health-api-service/.env  # Health API config
.env                         # Root config (copy of infrastructure/.env)
```

## Step 2: Start All Services (60 seconds)

```bash
# Start everything with one command
docker compose up -d

# Watch the logs
docker compose logs -f
```

**Services starting:**
- ğŸ” PostgreSQL (multi-database: healthapi, webauthn)
- ğŸ’¾ Redis (cache & sessions)
- ğŸ“Š Jaeger (distributed tracing)
- ğŸ”‘ WebAuthn Server (passkey authentication)
- ğŸ—„ï¸ MinIO (S3-compatible storage)
- ğŸ“¨ RabbitMQ (message queue)
- ğŸ¥ Health API (main application)

## Step 3: Verify Everything is Running

```bash
# Check service status
docker compose ps

# All services should show "healthy" or "running"
```

## Step 4: Access the Services

### Health API (Main Application)
- **Swagger UI**: http://localhost:8000/docs
- **Health Check**: http://localhost:8000/health/ready

### WebAuthn Server (Authentication)
- **Health Check**: http://localhost:8080/health
- **API Docs**: Check WebAuthn server README

### MinIO (Object Storage)
- **Console**: http://localhost:9001
- **Login**: Use credentials from `infrastructure/.env`
  ```bash
  # Get MinIO credentials
  grep DATALAKE_MINIO infrastructure/.env
  ```

### RabbitMQ (Message Queue)
- **Management UI**: http://localhost:15672
- **Login**: Use credentials from `infrastructure/.env`
  ```bash
  # Get RabbitMQ credentials
  grep MQ_RABBITMQ infrastructure/.env
  ```

### Jaeger (Distributed Tracing)
- **UI**: http://localhost:16686

## Running Tests

### Health API Integration Tests

```bash
# Navigate to health-api service
cd services/health-api-service

# Activate virtual environment
source .venv/bin/activate

# Run tests (will use .env file generated by setup script)
pytest tests/test_integration.py -v
```

### Data Lake Tests

```bash
# Navigate to data-lake service
cd services/data-lake

# Activate virtual environment (create if needed)
source .venv/bin/activate

# Run tests
pytest tests/
```

## Common Commands

### View Logs
```bash
# All services
docker compose logs -f

# Specific service
docker compose logs -f health-api
docker compose logs -f webauthn-server
docker compose logs -f postgres
```

### Restart Services
```bash
# Restart all
docker compose restart

# Restart specific service
docker compose restart health-api
```

### Stop Everything
```bash
# Stop services (keep data)
docker compose down

# Stop and remove all data
docker compose down -v
```

### Rebuild After Code Changes
```bash
# Rebuild and restart specific service
docker compose up -d --build health-api

# Rebuild everything
docker compose up -d --build
```

## Troubleshooting

### Services Won't Start

```bash
# Check for port conflicts
docker compose ps
lsof -i :8000  # Check if port is already in use

# View detailed logs
docker compose logs postgres
docker compose logs redis
```

### Database Connection Issues

```bash
# Verify PostgreSQL is healthy
docker compose exec postgres psql -U <POSTGRES_USER> -l

# Check if databases were created
docker compose exec postgres psql -U <POSTGRES_USER> -c "SELECT datname FROM pg_database;"

# Should see: healthapi, webauthn, health
```

### Re-generate Configuration

```bash
# Stop services
docker compose down -v

# Remove old .env files
rm -f .env infrastructure/.env services/*/service/.env

# Re-run setup
./setup-all-services.sh

# Start fresh
docker compose up -d
```

## Next Steps

### Development Workflow

1. **Make code changes** in your service directory
2. **Rebuild and restart** the service:
   ```bash
   docker compose up -d --build health-api
   ```
3. **Run tests** to verify:
   ```bash
   cd services/health-api-service
   source .venv/bin/activate
   pytest
   ```

### Adding a New Service (e.g., ETL Narrative Engine)

1. Create service directory: `services/etl-narrative-engine/`
2. Create `etl.compose.yml` in the service directory
3. Add to main `docker-compose.yml`:
   ```yaml
   include:
     # ... existing includes ...
     - path: services/etl-narrative-engine/etl.compose.yml
   ```
4. Update `setup-all-services.sh` to generate ETL service `.env`
5. Run setup and start:
   ```bash
   ./setup-all-services.sh
   docker compose up -d
   ```

### Using WebAuthn Authentication

The WebAuthn server provides passkey-based authentication. To integrate:

1. **Register a user** via WebAuthn server
2. **Get JWT token** from WebAuthn authentication
3. **Use token** in Health API requests:
   ```bash
   curl -H "Authorization: Bearer <JWT_TOKEN>" http://localhost:8000/v1/upload
   ```

See `DOCKER_COMPOSE_GUIDE.md` for more details.

## Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Android Client  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â–º WebAuthn Server â”€â”€â–º PostgreSQL (webauthn DB)
         â”‚         â”‚                 â””â”€â”€â–º Redis (sessions)
         â”‚         â”‚                 â””â”€â”€â–º Jaeger (tracing)
         â”‚         â†“
         â”‚    [JWT Token]
         â”‚         â†“
         â””â”€â”€â–º Health API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º PostgreSQL (healthapi DB)
                   â”‚                 â”œâ”€â”€â–º Redis (rate limiting)
                   â”‚                 â”œâ”€â”€â–º MinIO (file storage)
                   â”‚                 â””â”€â”€â–º RabbitMQ (async tasks)
                   â”‚
                   â†“
              ETL Narrative Engine (future)
```

## Additional Resources

- **Docker Compose Guide**: `DOCKER_COMPOSE_GUIDE.md` - Detailed compose file documentation
- **Architecture**: `docs/architecture/` - System design documentation
- **WebAuthn Server**: Check `mpo-api-authn-server` repository
- **Service Implementations**: Each service has `implementation_plan.md`

## Security Notes

ğŸ”’ **The setup script generates random credentials every time it runs**

- Never commit `.env` files to git
- `.env` files are in `.gitignore`
- For production, use proper secrets management (Vault, AWS Secrets Manager, etc.)
- Change the WebAuthn RP_ID and ORIGIN for your domain

## Support

- Issues: Open an issue in the GitHub repository
- Documentation: Check `docs/` directory
- Service-specific help: See each service's README
