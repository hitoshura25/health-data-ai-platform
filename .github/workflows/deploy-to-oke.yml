name: Deploy to Oracle OKE

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - staging
          - production
      chart_version:
        description: 'Helm chart version (optional, defaults to latest)'
        required: false
        type: string
      dry_run:
        description: 'Perform dry-run only'
        required: false
        type: boolean
        default: false

env:
  HELM_VERSION: 'v3.14.0'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Configure OCI CLI
        uses: oracle-actions/configure-oci-cli@v1
        with:
          user: ${{ secrets.OCI_USER_OCID }}
          fingerprint: ${{ secrets.OCI_FINGERPRINT }}
          tenancy: ${{ secrets.OCI_TENANCY_OCID }}
          region: ${{ secrets.OCI_REGION }}
          key_content: ${{ secrets.OCI_PRIVATE_KEY }}

      - name: Set up kubectl
        uses: oracle-actions/configure-kubectl-oke@v1
        with:
          cluster: ${{ secrets.OKE_CLUSTER_OCID }}

      - name: Verify cluster connection
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Add Helm repositories
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo add jaegertracing https://jaegertracing.github.io/helm-charts
          helm repo update

      - name: Update Helm dependencies
        run: |
          cd helm-charts/health-platform
          helm dependency update

      - name: Set environment-specific values
        id: env-values
        run: |
          ENV="${{ github.event.inputs.environment }}"
          echo "values_file=values-${ENV}.yaml" >> $GITHUB_OUTPUT
          echo "namespace=health-platform-${ENV}" >> $GITHUB_OUTPUT
          echo "release_name=health-platform-${ENV}" >> $GITHUB_OUTPUT

      - name: Create namespace if not exists
        run: |
          kubectl create namespace ${{ steps.env-values.outputs.namespace }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Create image pull secret
        run: |
          kubectl create secret docker-registry ghcr-secret \
            --docker-server=ghcr.io \
            --docker-username=${{ github.actor }} \
            --docker-password=${{ secrets.GITHUB_TOKEN }} \
            --namespace=${{ steps.env-values.outputs.namespace }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Prepare Helm values
        run: |
          cd helm-charts/health-platform

          # Create custom values overlay for this deployment
          cat > /tmp/deploy-values.yaml << EOF
          global:
            imagePullSecrets:
              - name: ghcr-secret
            environment: ${{ github.event.inputs.environment }}

          # Image tags will be pulled from the values file updated by CI
          EOF

      - name: Helm diff (preview changes)
        if: github.event.inputs.dry_run == 'true' || github.event.inputs.environment == 'production'
        run: |
          cd helm-charts/health-platform

          # Install helm diff plugin
          helm plugin install https://github.com/databus23/helm-diff || true

          helm diff upgrade ${{ steps.env-values.outputs.release_name }} . \
            --namespace ${{ steps.env-values.outputs.namespace }} \
            --values ${{ steps.env-values.outputs.values_file }} \
            --values /tmp/deploy-values.yaml \
            --allow-unreleased \
            || echo "First deployment - no diff available"

      - name: Deploy with Helm (dry-run)
        if: github.event.inputs.dry_run == 'true'
        run: |
          cd helm-charts/health-platform

          helm upgrade --install ${{ steps.env-values.outputs.release_name }} . \
            --namespace ${{ steps.env-values.outputs.namespace }} \
            --values ${{ steps.env-values.outputs.values_file }} \
            --values /tmp/deploy-values.yaml \
            --create-namespace \
            --dry-run \
            --debug

      - name: Deploy with Helm
        if: github.event.inputs.dry_run != 'true'
        run: |
          cd helm-charts/health-platform

          helm upgrade --install ${{ steps.env-values.outputs.release_name }} . \
            --namespace ${{ steps.env-values.outputs.namespace }} \
            --values ${{ steps.env-values.outputs.values_file }} \
            --values /tmp/deploy-values.yaml \
            --create-namespace \
            --wait \
            --timeout 10m \
            --atomic

      - name: Verify deployment
        if: github.event.inputs.dry_run != 'true'
        run: |
          echo "Checking deployment status..."
          kubectl get all -n ${{ steps.env-values.outputs.namespace }}

          echo ""
          echo "Checking pod status..."
          kubectl wait --for=condition=ready pod \
            --all \
            --namespace=${{ steps.env-values.outputs.namespace }} \
            --timeout=300s || true

          echo ""
          echo "Recent events:"
          kubectl get events -n ${{ steps.env-values.outputs.namespace }} \
            --sort-by='.lastTimestamp' \
            | tail -20

      - name: Run smoke tests
        if: github.event.inputs.dry_run != 'true'
        run: |
          echo "Running smoke tests..."

          # Wait for health checks to be ready
          sleep 30

          # Test Health API health endpoint
          HEALTH_API_POD=$(kubectl get pods -n ${{ steps.env-values.outputs.namespace }} \
            -l app.kubernetes.io/name=health-api \
            -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")

          if [ ! -z "$HEALTH_API_POD" ]; then
            echo "Testing Health API..."
            kubectl exec -n ${{ steps.env-values.outputs.namespace }} $HEALTH_API_POD \
              -- curl -f http://localhost:8000/health/live || echo "Health API check failed"
          fi

      - name: Get deployment info
        if: github.event.inputs.dry_run != 'true'
        run: |
          echo "Deployment completed!"
          echo ""
          echo "Release info:"
          helm list -n ${{ steps.env-values.outputs.namespace }}

          echo ""
          echo "Service endpoints:"
          kubectl get svc -n ${{ steps.env-values.outputs.namespace }}

          echo ""
          echo "Ingress info:"
          kubectl get ingress -n ${{ steps.env-values.outputs.namespace }} || echo "No ingresses found"

      - name: Rollback on failure
        if: failure() && github.event.inputs.dry_run != 'true'
        run: |
          echo "Deployment failed, rolling back..."
          helm rollback ${{ steps.env-values.outputs.release_name }} \
            --namespace ${{ steps.env-values.outputs.namespace }} \
            || echo "Rollback failed or no previous revision available"

  notify:
    needs: deploy
    runs-on: ubuntu-latest
    if: always() && github.event.inputs.dry_run != 'true'
    steps:
      - name: Send deployment notification
        run: |
          echo "Deployment to ${{ github.event.inputs.environment }}: ${{ needs.deploy.result }}"
          # Add Slack/email notification here if needed
