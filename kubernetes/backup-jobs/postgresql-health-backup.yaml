apiVersion: v1
kind: ConfigMap
metadata:
  name: postgresql-backup-script
  namespace: health-data
data:
  backup.sh: |
    #!/bin/bash
    set -e

    TIMESTAMP=$(date +%Y%m%d-%H%M%S)
    BACKUP_FILE="postgres-health-${TIMESTAMP}.dump"
    BACKUP_PATH="/tmp/${BACKUP_FILE}"

    echo "==========================================="
    echo "PostgreSQL Health Database Backup"
    echo "Started at: $(date)"
    echo "==========================================="

    # Create backup using pg_dump with custom format (includes compression)
    echo "Creating database dump..."
    PGPASSWORD="${POSTGRES_PASSWORD}" pg_dump \
      -h "${POSTGRES_HOST}" \
      -p "${POSTGRES_PORT}" \
      -U "${POSTGRES_USER}" \
      -d "${POSTGRES_DB}" \
      --format=custom \
      --compress=6 \
      --verbose \
      --no-owner \
      --no-acl \
      --file="${BACKUP_PATH}"

    BACKUP_SIZE=$(du -h "${BACKUP_PATH}" | cut -f1)
    echo "Backup created: ${BACKUP_FILE} (${BACKUP_SIZE})"

    # Upload to OCI Object Storage using pre-authenticated request
    if [ -n "${OCI_UPLOAD_URL}" ]; then
      echo "Uploading to OCI Object Storage..."
      HTTP_CODE=$(curl -X PUT \
        --upload-file "${BACKUP_PATH}" \
        "${OCI_UPLOAD_URL}/${BACKUP_FILE}" \
        --write-out "%{http_code}" \
        --silent \
        --output /dev/null)

      if [ "${HTTP_CODE}" -eq 200 ] || [ "${HTTP_CODE}" -eq 201 ]; then
        echo "Upload successful (HTTP ${HTTP_CODE})"
      else
        echo "ERROR: Upload failed with HTTP ${HTTP_CODE}"
        exit 1
      fi
    else
      echo "WARNING: OCI_UPLOAD_URL not set, backup saved locally only"
    fi

    # Cleanup local backup
    rm -f "${BACKUP_PATH}"

    echo "==========================================="
    echo "Backup completed successfully"
    echo "Finished at: $(date)"
    echo "==========================================="

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgresql-health-backup
  namespace: health-data
  labels:
    app: postgresql-backup
    database: health-data
spec:
  schedule: "0 3 * * *"  # Daily at 3 AM UTC
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid

  jobTemplate:
    metadata:
      labels:
        app: postgresql-backup
        database: health-data
    spec:
      backoffLimit: 2
      template:
        metadata:
          labels:
            app: postgresql-backup
            database: health-data
        spec:
          restartPolicy: OnFailure

          containers:
          - name: pg-backup
            image: postgres:15-alpine
            command: ["/bin/sh"]
            args: ["/scripts/backup.sh"]

            env:
            - name: POSTGRES_HOST
              value: "postgresql-health-primary"
            - name: POSTGRES_PORT
              value: "5432"
            - name: POSTGRES_USER
              value: "healthapi"
            - name: POSTGRES_DB
              value: "healthdb"
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgresql-health-secret
                  key: password
            - name: OCI_UPLOAD_URL
              valueFrom:
                secretKeyRef:
                  name: backup-oci-config
                  key: database-upload-url
                  optional: true

            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                cpu: 500m
                memory: 512Mi

            volumeMounts:
            - name: backup-script
              mountPath: /scripts
              readOnly: true

          volumes:
          - name: backup-script
            configMap:
              name: postgresql-backup-script
              defaultMode: 0755

---
# Secret template for OCI upload configuration
# Create this secret separately with actual values
apiVersion: v1
kind: Secret
metadata:
  name: backup-oci-config
  namespace: health-data
type: Opaque
stringData:
  # Pre-authenticated request URL for database backups
  # Create this in OCI Console: Object Storage > Bucket > Pre-Authenticated Requests
  database-upload-url: "https://objectstorage.eu-amsterdam-1.oraclecloud.com/p/YOUR_PAR_TOKEN/n/NAMESPACE/b/health-platform-db-backups/o"

  # Retention policy (days)
  retention-days: "7"
